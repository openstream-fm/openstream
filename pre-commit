#!/usr/bin/env zx

// this pre-commit hook ensure that the repo has the 
// latest ts definitions as they are generated from
// cargo test command, without this ci tests on frontend could fail
// it also ensures that the package-lock files are OK running npm ci on all npm packages

const write = (str) => {
	process.stdout.write(str);
}

const writeln = (str) => {
	process.stdout.write(str + "\n");
}

const check = () => {
	writeln(` ${chalk.green("âœ“")}`);
}


await within(async () => {
	$.verbose = false;
	const root = (await $`git rev-parse --show-toplevel`).stdout.trim();
	cd(root);
	
	write(`Cleaning defs directory...`);
	await $`rm -rf ./defs`;
	check();

	write(`Running cargo tests...`);
	await $`cargo test --color always`;
	await $`git add ./defs`
	check();

	await within(async () => {
		write(`Running front npm ci...`);
		cd("front");
		await $`npm run ci`;
		await $`git add .`;
		check();
	})

	writeln("Done!")
})